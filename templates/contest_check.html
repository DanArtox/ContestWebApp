{% csrf_token %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ –∫–∞–Ω–∞–ª–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh; /* –í—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞ */
            margin: 0;
            font-family: Arial, sans-serif;
            background: url(https://furman.top/uploads/posts/2022-06/1654038490_34-furman-top-p-fon-vatsap-standartnii-krasivie-36.png);
            background-color: #f0f0f0; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ */
        }

        h1 {
            font-size: 2em; /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            color: #333; /* –¶–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            margin: 10px 0; /* –û—Ç—Å—Ç—É–ø—ã –≤–æ–∫—Ä—É–≥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        }

        .emoji {
            font-size: 5em; /* –†–∞–∑–º–µ—Ä —Å–º–∞–π–ª–∏–∫–∞ */
        }

        .main {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 20vh; /* –í—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞ */
            padding: 40px;
            font-family: Arial, sans-serif;
            border-radius: 10px;
            background-color: #f1e9e9;
            box-shadow: 0 17px 20px rgba(0, 0, 0, 0.35);
        }
    </style>
</head>
<body>
    <div class="main">
        <div class="emoji">üé≤</div>
        <h1 style="font-family: 'Rubik';">–ü—Ä–æ–≤–µ—Ä–∫–∞...</h1>
    </div>
    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        Telegram.WebApp.ready(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        // const telegramUserId = Telegram.WebApp.initDataUnsafe.user.id; // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // const telegramUserName = Telegram.WebApp.initDataUnsafe.user.username; // –ü–æ–ª—É—á–∞–µ–º Username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const telegramUserId = 6616327061;
        const telegramUserName = 'Dan_4rt0x';

        // const startappParam = Telegram.WebApp.initDataUnsafe.start_param;
        const startappParam = '-1002390255063-123--1002384870119___2___b-random_contestBot_321_c-_999_L2H0VHtzG985OGMy';
        const parts = startappParam.split('___');
        const channelsString = parts[0];
        let channels;
        if (channelsString.includes('-123-')) {
            channels = channelsString.split('-123-'); // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ –∑–∞–ø—è—Ç–æ–π
        } else {
            channels = [channelsString]; // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ —Å –æ–¥–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
        }

        const nc = parts[1];
        const ads = parts[2];

        async function addUser(telegramUserId, telegramUserName) {
            try {
                const resp = await fetch('/add-user/?uid=' + telegramUserId + '&username=' + telegramUserName);
                const data = await resp.json(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
                console.log(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏
        addUser(telegramUserId, telegramUserName);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª–∞—Ö
        function checkUserParticipation() {
            let isUserInChannels = false;
            let requests = [];

            for (let i = 0; i < channels.length; i++) {
                const channel = channels[i];
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
                requests.push(
                    fetch(`/check-participation/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({
                            channel_id: channel, // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —É –∫–∞–Ω–∞–ª–∞ –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                            user_id: telegramUserId, // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_subscribed) { // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–µ is_subscribed
                            isUserInChannels = true;
                        } else {
                            isUserInChannels = false;
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞:', error);
                    })
                );
            }

            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            Promise.all(requests).then(() => {
                // –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
                if (isUserInChannels) {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–≤—É–µ—Ç, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–Ω–∞–ª–∞
                    window.location.href = "/success/?nc=" + nc + "&ads=" + ads + "&uid=" + telegramUserId; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    window.location.href = "/failure/"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
                }
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ cookie —Å –∏–º–µ–Ω–∏ –Ω—É–∂–Ω–æ–≥–æ cookie
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—á–∞—Å—Ç–∏—è
        setTimeout(() => { checkUserParticipation(); }, 1500);
        // checkUserParticipation();
    </script>
</body>
</html>